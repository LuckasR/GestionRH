<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/themeleaf/layout"
  layout:decorate="~{fragment/template1}">
<body>
  <div layout:fragment="content">
    <div class="content-wrapper">
      <div class="container-xxl flex-grow-1 container-p-y">
        
        <!-- ============================================= -->
        <!-- ROW 1: KPI CARDS (Global Stats)               -->
        <!-- ============================================= -->
        <div class="row">
          
          <!-- 1. Global Turnover Rate -->
          <div class="col-lg-3 col-md-6 col-12 mb-4">
            <div class="card">
              <div class="card-body">
                <div class="card-title d-flex align-items-start justify-content-between">
                  <div class="avatar flex-shrink-0">
                    <span class="avatar-initial rounded bg-label-danger"><i class="bx bx-line-chart-down"></i></span>
                  </div>
                </div>
                <span class="fw-semibold d-block mb-1">Taux Turnover</span>
                <!-- Backend Variable: turnoverRate -->
                <h3 class="card-title mb-2" th:text="${turnoverRate != null ? turnoverRate : '0'} + '%'">12.5%</h3>
                <small class="text-danger fw-semibold">Global</small>
              </div>
            </div>
          </div>

          <!-- 2. Absence Rate -->
          <div class="col-lg-3 col-md-6 col-12 mb-4">
            <div class="card">
              <div class="card-body">
                <div class="card-title d-flex align-items-start justify-content-between">
                  <div class="avatar flex-shrink-0">
                    <span class="avatar-initial rounded bg-label-warning"><i class="bx bx-user-x"></i></span>
                  </div>
                </div>
                <span class="fw-semibold d-block mb-1">Taux Absentéisme</span>
                <h3 class="card-title text-nowrap mb-1" th:text="${absenceRate != null ? absenceRate : '0'} + '%'">4.2%</h3>
                <small class="text-muted">Moyenne annuelle</small>
              </div>
            </div>
          </div>

          <!-- 3. Seniority (Ancienneté) -->
          <div class="col-lg-3 col-md-6 col-12 mb-4">
            <div class="card">
              <div class="card-body">
                <div class="card-title d-flex align-items-start justify-content-between">
                  <div class="avatar flex-shrink-0">
                    <span class="avatar-initial rounded bg-label-primary"><i class="bx bx-time-five"></i></span>
                  </div>
                </div>
                <span class="fw-semibold d-block mb-1">Ancienneté Moy.</span>
                <h3 class="card-title text-nowrap mb-1" th:text="${avgSeniority != null ? avgSeniority : '0'} + ' Ans'">3.5 Ans</h3>
                <small class="text-muted">Fidélité</small>
              </div>
            </div>
          </div>

          <!-- 4. Total Employees -->
          <div class="col-lg-3 col-md-6 col-12 mb-4">
            <div class="card">
              <div class="card-body">
                <div class="card-title d-flex align-items-start justify-content-between">
                  <div class="avatar flex-shrink-0">
                    <span class="avatar-initial rounded bg-label-success"><i class="bx bx-group"></i></span>
                  </div>
                </div>
                <span class="fw-semibold d-block mb-1">Effectif Total</span>
                <h3 class="card-title text-nowrap mb-1" th:text="${totalEmployees}">142</h3>
                <small class="text-success fw-semibold">Actifs</small>
              </div>
            </div>
          </div>
        </div>

        <!-- ============================================= -->
        <!-- ROW 2: TURNOVER DETAILS & SERVICE CHART       -->
        <!-- ============================================= -->
        <div class="row">
          
          <!-- LEFT: Turnover List -->
          <div class="col-12 col-lg-8 order-2 order-md-3 order-lg-2 mb-4">
            <div class="card h-100">
              <div class="card-header d-flex align-items-center justify-content-between">
                <h5 class="card-title m-0 me-2">Turnover par Poste</h5>
              </div>
              <div class="card-body">
                <div class="table-responsive text-nowrap">
                  <table class="table table-borderless">
                    <thead>
                      <tr>
                        <th>Poste</th>
                        <th>Départs</th>
                        <th>Impact</th>
                        <th>Tendance</th>
                      </tr>
                    </thead>
                    <tbody>
                      <!-- THYMELEAF LOOP START -->
                      <!-- <tr th:each="item : ${turnoverList}"> -->
                      
                      <!-- Demo Row 1 -->
                      <tr>
                        <td><i class="fab fa-angular fa-lg text-danger me-3"></i> <strong>Dev Junior</strong></td>
                        <td>5</td>
                        <td>
                          <div class="d-flex align-items-center">
                            <span class="me-2">High</span>
                            <div class="progress w-100" style="height: 8px;">
                              <div class="progress-bar bg-danger" role="progressbar" style="width: 80%"></div>
                            </div>
                          </div>
                        </td>
                        <td><span class="badge bg-label-danger">Critical</span></td>
                      </tr>
                      
                      <!-- Demo Row 2 -->
                      <tr>
                        <td><i class="fab fa-react fa-lg text-info me-3"></i> <strong>Commercial</strong></td>
                        <td>2</td>
                        <td>
                          <div class="d-flex align-items-center">
                            <span class="me-2">Med</span>
                            <div class="progress w-100" style="height: 8px;">
                              <div class="progress-bar bg-warning" role="progressbar" style="width: 40%"></div>
                            </div>
                          </div>
                        </td>
                        <td><span class="badge bg-label-warning">Stable</span></td>
                      </tr>
                      <!-- THYMELEAF LOOP END -->

                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <!-- RIGHT: Service Distribution -->
          <div class="col-md-6 col-lg-4 col-xl-4 order-0 mb-4">
            <div class="card h-100">
              <div class="card-header d-flex align-items-center justify-content-between pb-0">
                <div class="card-title mb-0">
                  <h5 class="m-0 me-2">Par Département</h5>
                </div>
              </div>
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                  <!-- Chart Container -->
                  <div id="serviceDistributionChart"></div> 
                </div>
                <div class="text-center">
                    <small class="text-muted">Répartition des effectifs</small>
                </div>
              </div>
            </div>
          </div>
        </div> 

        <!-- ============================================= -->
        <!-- ROW 3: CONTRACTS & AGE PYRAMID                -->
        <!-- ============================================= -->
        <div class="row">
          
          <!-- REPLACED GENDER WITH CONTRACTS (Since you have contrat_id) -->
          <div class="col-md-6 col-lg-6 mb-4">
            <div class="card h-100">
              <div class="card-header">
                <h5 class="card-title">Répartition par Contrat</h5>
              </div>
              <div class="card-body">
                <div id="contractChart"></div> 
                <div class="d-flex justify-content-center pt-4 gap-2">
                    <small class="text-muted">Basé sur les contrats actifs</small>
                </div>
              </div>
            </div>
          </div>

          <!-- Age Pyramid (Global, without gender split) -->
          <div class="col-md-6 col-lg-6 mb-4">
            <div class="card h-100">
              <div class="card-header">
                <h5 class="card-title">Pyramide des Âges</h5>
              </div>
              <div class="card-body">
                <div id="ageChart"></div> 
                <div class="text-center fw-semibold pt-3 mb-2">
                    <!-- Optional: backend variable for average age -->
                    Moyenne d'âge: <span th:text="${avgAge}">29</span> Ans
                </div>
              </div>
            </div>
          </div>
          
        </div>

      </div>
    </div>
  </div>
  
  <!-- ============================================= -->
  <!-- JAVASCRIPT FOR CHARTS                         -->
  <!-- ============================================= -->
  <th:block layout:fragment="page-scripts">
    <script th:inline="javascript">
      
      // 1. SERVICE CHART (Donut)
      // ========================
      const serviceChartEl = document.querySelector('#serviceDistributionChart');
      if (serviceChartEl) {
        /* Get data from Java: var serviceData = [[${serviceCounts}]]; */
        var serviceData = [45, 12, 25, 10]; // Demo Data
        var serviceLabels = ['IT', 'RH', 'Sales', 'Finance']; // Demo Labels

        const serviceChartConfig = {
          chart: { type: 'donut', height: 220 },
          series: serviceData, 
          labels: serviceLabels,
          dataLabels: { enabled: false },
          legend: { show: false },
          colors: ['#696cff', '#8592a3', '#71dd37', '#03c3ec']
        };
        new ApexCharts(serviceChartEl, serviceChartConfig).render();
      }

      // 2. CONTRACT CHART (Replaces Gender)
      // ===================================
      const contractChartEl = document.querySelector('#contractChart');
      if (contractChartEl) {
        /* Get data from Java: var contractData = [[${contractCounts}]]; */
        var contractData = [80, 40, 22]; // Demo Data
        var contractLabels = ['CDI', 'CDD', 'Stage']; 

        const contractChartConfig = {
          chart: { type: 'pie', height: 250 },
          series: contractData,
          labels: contractLabels,
          colors: ['#71dd37', '#ffab00', '#233446'], // Green, Orange, Dark
          legend: { position: 'bottom' }
        };
        new ApexCharts(contractChartEl, contractChartConfig).render();
      }

      // 3. AGE CHART (Horizontal Bar / Pyramid style)
      // =============================================
      const ageChartEl = document.querySelector('#ageChart');
      if (ageChartEl) {
        /* Get data from Java: var ageData = [[${ageDistribution}]]; */
        var ageData = [5, 15, 40, 20, 5]; // Demo Data
        var ageCategories = ['18-24', '25-30', '30-40', '40-50', '50+'];

        const ageChartConfig = {
          chart: { type: 'bar', height: 250, toolbar: {show:false} },
          series: [{ name: 'Employés', data: ageData }],
          xaxis: { categories: ageCategories },
          plotOptions: {
            bar: { borderRadius: 4, horizontal: true, barHeight: '50%' }
          },
          colors: ['#696cff'],
          dataLabels: { enabled: true }
        };
        new ApexCharts(ageChartEl, ageChartConfig).render();
      }
    </script>
  </th:block>

</body>
</html>