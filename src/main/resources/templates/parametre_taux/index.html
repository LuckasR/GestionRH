<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
    xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{fragment/template1}">
    <body>
        <div layout:fragment="content">

            <div class="container-fluid mt-4">
                <div
                    class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="text-primary"><i class="fas fa-cogs"></i> Liste
                        des Paramètres de Taux</h2>
                    <a th:href='@{/parametre_taux/create}'
                        class="btn btn-success">
                        Nouveau Paramètre
                    </a>
                </div>

                <!-- ======================================================= -->
                <!-- SECTION 1: SEARCH FILTER FORM                           -->
                <!-- ======================================================= -->
                <div class="card mb-4 border-secondary shadow-sm">
                    <div class="card-header">
                        <h5 class="mb-0">Filtres
                            de recherche</h5>
                    </div>
                    <div class="card-body">
                        <!-- IMPORTANT: Added Form Tag -->
                        <!---<form th:action="@{/parametre_taux_mamy/filter}" method="post">--->

                            <!-- Row 1: Code and Dates -->
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label
                                        class="form-label fw-bold">Code</label>
                                    <input type="text" class="form-control"
                                        name="code" placeholder="Ex: IRSA...">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-bold">Date
                                        Début</label>
                                    <input type="date" class="form-control"
                                        name="date_debut">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-bold">Date
                                        Fin</label>
                                    <input type="date" class="form-control"
                                        name="date_fin">
                                </div>
                            </div>

                            <!-- Row 2: Taux Employé (Min / Max) -->
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label
                                        class="form-label fw-bold text-primary">Taux
                                        Employé (%)</label>
                                    <div class="input-group">
                                        <input type="number" step="0.01"
                                            class="form-control"
                                            name="taux_employe_min" placeholder="Min">
                                        <span class="input-group-text">-</span>
                                        <input type="number" step="0.01"
                                            class="form-control"
                                            name="taux_employe_max" placeholder="Max">
                                    </div>
                                </div>
                                <!-- Row 2: Taux Employeur (Min / Max) -->
                                <div class="col-md-6">
                                    <label
                                        class="form-label fw-bold text-primary">Taux
                                        Employeur (%)</label>
                                    <div class="input-group">
                                        <input type="number" step="0.01"
                                            class="form-control"
                                            name="taux_employeur_min"
                                            placeholder="Min">
                                        <span class="input-group-text">-</span>
                                        <input type="number" step="0.01"
                                            class="form-control"
                                            name="taux_employeur_max"
                                            placeholder="Max">
                                    </div>
                                </div>
                            </div>

                            <!-- Row 3: Actif & Buttons -->
                            <div class="row align-items-center">
                                <div class="col-md-4">
                                    <div class="form-check form-switch mt-2">
                                        <input class="form-check-input"
                                            type="checkbox" id="actifCheck"
                                            name="actif" value="true">
                                        <label class="form-check-label"
                                            for="actifCheck">Uniquement
                                            Actif</label>
                                    </div>
                                </div>
                                <div class="col-md-8 text-end">
                                    <a th:href="@{/parametre_taux_mamy}"
                                        class="btn btn-secondary me-2">Réinitialiser</a>
                                    <button type="submit"
                                        class="btn btn-primary px-4" id="rechercher">
                                        Filtrer</button>
                                </div>
                            </div>
                        <!---</form>--->
                    </div>
                </div>

                <!-- ======================================================= -->
                <!-- SECTION 2: RESULTS (TWO TABLES)                         -->
                <!-- ======================================================= -->

                <!-- 1. TAUX FORFAITAIRES (GLOBAL) -->
                <div class="card mb-4 border-primary">
                    <div class="card-header text-white">
                        <h5 class="mb-0"><i class="fas fa-globe"></i> Taux
                            Forfaitaires (Globaux)</h5>
                    </div>
                    <div class="card-body p-0 table-responsive valiny">
                        <table
                            class="table table-striped table-hover mb-0 align-middle">
                            <thead>
                                <tr>
                                    <th>Code</th>
                                    <th>Description</th>
                                    <th>Taux Employé</th>
                                    <th>Taux Employeur</th>
                                    <th>Dates</th>
                                    <th>Statut</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- CHECK: List not empty AND First Element Min is NULL -->
                                <tr th:each='row : ${parametre_tauxs}'
                                    th:if="${not #lists.isEmpty(row.details) and row.details[0].montant_min == null}">

                                    <td th:text='${row.code}'
                                        class="fw-bold"></td>
                                    <td th:text='${row.description}'></td>

                                    <!-- GLOBAL RATE DISPLAY -->
                                    <td><span class="badge bg-primary text-white"
                                            style="font-size:1em;"
                                            th:text="${row.details[0].taux.taux_employe + '%'}"></span></td>
                                    <td><span class="badge bg-primary text-white"
                                            style="font-size:1em;"
                                            th:text="${row.details[0].taux.taux_employeur + '%'}"></span></td>

                                    <td>
                                        <!-- Matches Entity field: date_application -->
                                        <div
                                            th:text="${row.date_application}"></div>
                                        <small class="text-muted"
                                            th:text="${row.date_fin}"></small>
                                    </td>

                                    <td>
                                        <span th:if="${row.actif}"
                                            class="badge bg-success">Actif</span>
                                        <span th:unless="${row.actif}"
                                            class="badge bg-secondary">Inactif</span>
                                    </td>

                                    <td>
                                        <div class="btn-group">
                                            <a
                                                th:href='@{/parametre_taux/edit/{id}(id=${row.id})}'
                                                class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <a
                                                th:href='@{/parametre_taux/delete/{id}(id=${row.id})}'
                                                class="btn btn-sm btn-outline-danger"
                                                onclick="return confirm('Confirmer la suppression ?')">
                                                <i class="fas fa-trash"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- 2. TAUX À PALIERS (INTERVALS) -->
                <div class="card border-success shadow-sm">
                    <div class="card-header text-white">
                        <h5 class="mb-0"><i class="fas fa-layer-group"></i> Taux
                            à Paliers (Progressifs)</h5>
                    </div>
                    <div class="card-body p-0">
                        <table class="table table-hover mb-0 align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Code</th>
                                    <th>Description</th>
                                    <th style="width: 40%;">Détails des Paliers
                                        (Min - Max : Taux)</th>
                                    <th>Dates</th>
                                    <th>Statut</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- CHECK: List not empty AND First Element Min is NOT NULL -->
                                <tr th:each='row : ${parametre_tauxs}'
                                    th:if="${not #lists.isEmpty(row.details) and row.details[0].montant_min != null}">

                                    <td th:text='${row.code}'
                                        class="fw-bold text-success"></td>
                                    <td th:text='${row.description}'></td>

                                    <!-- INTERVAL LIST DISPLAY -->
                                    <td>
                                        <ul
                                            class="list-group list-group-flush small">
                                            <li
                                                class="list-group-item d-flex justify-content-between align-items-center px-2 py-1"
                                                th:each="detail : ${row.details}">
                                                <!-- 1. Case: Standard Interval (e.g., 350,000 to 400,000) -->
                                                <!-- We check if Min exists. We assume Min is the starting point. -->
                                                <span
                                                    th:if="${detail.montant_min != null}">
                                                    De <b
                                                        th:text="${#numbers.formatDecimal(detail.montant_min, 0, 'POINT', 0, 'POINT')}"> </b> Ar

                                                    <!-- Sub-logic for Max -->
                                                    <span
                                                        th:if="${detail.montant_max != null}">
                                                        à <b
                                                            th:text="${#numbers.formatDecimal(detail.montant_max, 0, 'POINT', 0, 'POINT')}"> </b> Ar
                                                    </span>
                                                    <span
                                                        th:if="${detail.montant_max == null}">
                                                        et plus
                                                        <!-- This handles 'Infini' -->
                                                    </span>
                                                </span>

                                                <!-- 2. Case: Ceiling Only (e.g., Up to 350,000, where Min is null) -->
                                                <span
                                                    th:if="${detail.montant_min == null and detail.montant_max != null}">
                                                    Jusqu'à <b
                                                        th:text="${#numbers.formatDecimal(detail.montant_max, 0, 'POINT', 0, 'POINT')}"></b>
                                                    Ar
                                                </span>
                                                <span class="badge bg-success"
                                                    th:text="${detail.taux.taux_employe + '%'}"></span>
                                            </li>
                                        </ul>
                                    </td>

                                    <td>
                                        <!-- Matches Entity field: date_application -->
                                        <div
                                            th:text="${row.date_application}"></div>
                                        <small class="text-muted"
                                            th:text="${row.date_fin}"></small>
                                    </td>

                                    <td>
                                        <span th:if="${row.actif}"
                                            class="badge bg-success">Actif</span>
                                        <span th:unless="${row.actif}"
                                            class="badge bg-secondary">Inactif</span>
                                    </td>

                                    <td>
                                        <div class="btn-group">
                                            <a
                                                th:href='@{/parametre_taux/edit/{id}(id=${row.id})}'
                                                class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <a
                                                th:href='@{/parametre_taux/delete/{id}(id=${row.id})}'
                                                class="btn btn-sm btn-outline-danger"
                                                onclick="return confirm('Confirmer la suppression ?')">
                                                <i class="fas fa-trash"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

            </div> <!-- End Container -->

            <script th:src="@{/assets/js/fetch.js}"></script>
        </div>
    </body>
</html>